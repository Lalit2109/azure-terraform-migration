# Template for exporting a single subscription
# Used in matrix strategy for parallel execution

parameters:
- name: subscriptionId
  type: string
- name: subscriptionName
  type: string
- name: serviceConnection
  type: string
- name: configPath
  type: string
  default: 'pipelines/subscriptions.yaml'
- name: outputDir
  type: string
  default: '$(Pipeline.Workspace)/exports'
- name: gitBranch
  type: string
  default: 'main'
- name: pushToRepos
  type: string
  default: 'true'

steps:
- task: GoTool@0
  displayName: 'Install Go (for aztfexport)'
  inputs:
    version: '1.21.x'

- script: |
    echo "Installing aztfexport..."
    go install github.com/Azure/aztfexport@latest
    export PATH=$PATH:$(go env GOPATH)/bin
    aztfexport --version
    echo "##vso[task.prependpath]$(go env GOPATH)/bin"
  displayName: 'Install aztfexport'

- task: UsePythonVersion@0
  displayName: 'Setup Python'
  inputs:
    versionSpec: '3.10'
    addToPath: true

- script: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
  displayName: 'Install Python dependencies'

- task: TerraformInstaller@0
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: 'latest'

- task: AzureCLI@2
  displayName: 'Export Subscription: ${{ parameters.subscriptionName }}'
  inputs:
    azureSubscription: '${{ parameters.serviceConnection }}'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "=========================================="
      echo "Exporting Subscription: ${{ parameters.subscriptionName }}"
      echo "Subscription ID: ${{ parameters.subscriptionId }}"
      echo "Service Connection: ${{ parameters.serviceConnection }}"
      echo "=========================================="
      
      # Verify authentication
      az account show
      az account set --subscription "${{ parameters.subscriptionId }}"
      
      # Configure Git
      git config --global user.name "Azure Pipelines"
      git config --global user.email "azure-pipelines@devops.com"
      
      # Set up environment variables
      export SUBSCRIPTION_ID="${{ parameters.subscriptionId }}"
      export SUBSCRIPTION_NAME="${{ parameters.subscriptionName }}"
      export PUSH_TO_REPOS=${{ parameters.pushToRepos }}
      export GIT_BRANCH=${{ parameters.gitBranch }}
      export OUTPUT_DIR=${{ parameters.outputDir }}/${{ parameters.subscriptionName }}
      export LOG_LEVEL=INFO
      export CONFIG_PATH=${{ parameters.configPath }}
      export AZURE_DEVOPS_PAT=$(System.AccessToken)
      export SYSTEM_ACCESS_TOKEN=$(System.AccessToken)
      export LOG_ANALYTICS_WORKSPACE_ID=$(LOG_ANALYTICS_WORKSPACE_ID)
      export LOG_ANALYTICS_SHARED_KEY=$(LOG_ANALYTICS_SHARED_KEY)
      
      # Create output directory for this subscription
      mkdir -p "$OUTPUT_DIR"
      
      # Run export for this subscription
      echo "Starting export for subscription: ${{ parameters.subscriptionName }}"
      # main.py will use SUBSCRIPTION_ID env var to filter to single subscription
      python src/main.py
      
      echo "=========================================="
      echo "Export completed for: ${{ parameters.subscriptionName }}"
      echo "=========================================="
  env:
    SYSTEM_ACCESS_TOKEN: $(System.AccessToken)
    LOG_ANALYTICS_WORKSPACE_ID: $(LOG_ANALYTICS_WORKSPACE_ID)
    LOG_ANALYTICS_SHARED_KEY: $(LOG_ANALYTICS_SHARED_KEY)
  continueOnError: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish Subscription Export'
  inputs:
    pathToPublish: '${{ parameters.outputDir }}/${{ parameters.subscriptionName }}'
    artifactName: 'export-${{ parameters.subscriptionName }}'
    publishLocation: 'Container'
  condition: always()
  continueOnError: true

